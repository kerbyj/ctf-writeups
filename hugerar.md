# Network 200

**Hugerar**

**Author: Alexander Menshchikov (nostr)**

**Вводная:**

Имеется архив по ссылке https://hy17-hugerar.spb.ctf.su/network200.rar

Всё круто, вот только он весит 10гб и скорость точно не самая большая.

**1. Идем википедить HTTP.**

Сразу натыкаемся на раздел ```Докачка и фрагментарное скачивание```

```
Допустим, на 84-м мегабайте соединение с Интернетом прервалось и процесс загрузки 
приостановился. Когда соединение с Интернетом было восстановлено, менеджер закачек 
автоматически послал новый запрос на сервер, но с указанием выдать содержимое с 84-го мегабайта:

GET /conf-2009.avi HTTP/1.0
Host: example.org
Accept: */*
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Range: bytes=88080384-
Referer: http://example.org/
```

Итак, будем использовать заголовок range для фрагментарного скачивания.

**2. Структура рарника и скачивание**

Как и у всех файлов, у рара есть своя структура, подробнее тут - http://acritum.com/winrar/rar-format

Выкачаем при помощи курла первую часть.

```Shell
curl https://hy17-hugerar.spb.ctf.su/network200.rar -H "Range: bytes=0-150" --output wu.rar
```

Откроем через 010 editor с темплейтом для рара RAR.bt.

Видим:

![first010](https://kerby.space/wu/hackyou/first010.png)

Итак, что мы имеем?

* Struct RarBlock Marker headerSize = 7

* Struct RarBlock ArcHeader HeaderSize = 13


* Struct RarBlock block[0]:
  * HeaderSize = 42
  * RawDataSize = 66
  
* Struct RarBlock block[1]:
  * HeaderSize = 42
  * RawDataSize = 1458688000
  
  
 Отлично, у нас есть по сути главные хедеры рара, весь первый файл и заголовок второго файла.
  
 Чтобы добраться до третьего файла мы должны заполнить пустоту равную размеру данных во втором файле архива.
  
 **3. Обработка**
  
  
 *Чукча не читатель, чукча костылер. Спойлер: всё сводится к скачиванию хедеров и заполнению пространства с заголовком RawDataSize нульбайтами*
  
  
 Самый простой способ - поставить нульбайт на точке 7+13+42+66+42+1458688000-1=1458688169
 
 Почему -1? А потому что там заканчивался второй файл архива, дальше будет логичнее. Я уже не помню, но оно работает. 
  
 Напишем простой скрипт, который будет ставить нульбайт и заодно качать следующие заголовки.
  
 Почему n+1? Дело в том, что на n заканчивается rawdatasize прошлого элемента, а нам нужны заголовки следующего. Почему n+600? Тупо чтобы не пропустить нужное, взял с запасом.

```Python
import os
with open('bak.rar', 'r+') as f:
  n=1458688000+169
  f.seek(n)  # Перемещаемся к n-му байту от начала файла.
  f.write('\0') # Записываем туда нульбайт
  os.system(("curl https://hy17-hugerar.spb.ctf.su/network200.rar -H 'Range: bytes={}-{}' --output ar.rar").format(n+1, n+1+600))
```

Добавляем содержимое скачанного архива ar.rar к имеющемуся bak1.rar и получаем следующую структуру: 

![second010](https://kerby.space/wu/hackyou/second010.png)

Опять же нам интересны HeaderSize и RawdataSize, мы берем их значения, которые равны 44 и 221767680
и прибавляем к нашей переменной n, чтобы получить n=1458688000+169+44+221767680

В итоге через i проходов наш костыль принимает следующий вид:

```Python
import os
with open('bak.rar', 'r+') as f:
    n=1458688000+169+42+8005+44+221767680+40+37478400+42+
    1097420800+45+37990400+40+166866944+48+1377638400+43+1524428800+
    45+243019776+42+34+42+15411200+42+1435084800+44+265039872+43+
    913715200+49+103866368+45+1236480000
    f.seek(n)  #1458688168 Перемещаемся к 6-му байту от начала файла.
    f.write('\0')
    os.system(("curl https://hy17-hugerar.spb.ctf.su/network200.rar -H 'Range: bytes={}-{}' --output suka1.rar").format(n+1, n+1+600))
```


**Пример полной костылизации, который приводит к наблюдению за консолью с попиванием чаечка, за авторством juwilie:**
[HugeRar.py](https://github.com/juwilie/writeups/blob/master/hackyou2017/hugerar.md)


Сам же архив становится таким:

![thirty010](https://kerby.space/wu/hackyou/thirts010.png)

**4. Флаг**

Конечно же не можем пройти мимо кисы, которую зовут флагом.жпг

![kissa](https://kerby.space/wu/hackyou/flag.jpg)

Но это не флаг.

Истинный флаг находится в файле ```real_flag.txt```: **Flag is : D0_Y0u_lov3_jok3sss?**
